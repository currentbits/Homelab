---
- name: Deploy Portainer using Docker Compose (started by deploy user)
  hosts: all
  vars:
    deploy_user: "{{ lookup('env', 'DEPLOY_USER') | default('deploy') }}"
    portainer_data_path: "/opt/docker/portainer_data"
    portainer_port: 9443
    compose_file_path: "/opt/docker/portainer"

  tasks:
    # Ensure data directory exists
    - name: Create Portainer data directory
      file:
        path: "{{ portainer_data_path }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    # Ensure /opt/docker directory exists
    - name: Create Docker Compose directory
      file:
        path: "{{ compose_file_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Fix Portainer data directory permissions
      file:
         path: "{{ portainer_data_path }}"
         state: directory
         owner: root
         group: docker
         recurse: yes
         mode: '0775'


    # Create docker-compose.yml
    - name: Create docker-compose.yml
      copy:
        dest: "{{ compose_file_path }}/docker-compose.yml"
        owner: root
        group: root
        mode: '0644'
        content: |
          version: "3.9"
          services:
            portainer:
              image: portainer/portainer-ce:latest
              container_name: portainer
              restart: always
              ports:
                - "{{ portainer_port }}:9443"
              volumes:
                - "{{ portainer_data_path }}:/data"
                - "/var/run/docker.sock:/var/run/docker.sock:ro"
          # NOTE: no 'user:' inside container

    # Ensure deploy user is in docker group
    - name: Add deploy user to docker group
      user:
        name: "{{ deploy_user }}"
        groups: docker
        append: yes

    # Start stack as deploy user
    - name: Deploy Portainer stack
      command: docker compose up -d
      args:
        chdir: "{{ compose_file_path }}"
      become_user: "{{ deploy_user }}"
      environment:
        DOCKER_BUILDKIT: 1

    # Cleanup dangling images
    - name: Clean up dangling images
      command: docker image prune -f
      become_user: "{{ deploy_user }}"
