---
- name: Update and upgrade Ubuntu/debian servers
  hosts: all
  gather_facts: yes

  tasks:
    - name: Update apt package index
      apt:
        update_cache: yes

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Reboot if needed
      reboot:
        msg: "Reboot after upgrade"
      when: ansible_facts.get('reboot_required', False)
    
    - name: Notify Discord that the task is done
      uri:
        url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: |
          {
            "content": "âœ… Task '{{ ansible_play_name }}' completed successfully on host {{ inventory_hostname }}."
          }
        body_format: json
        status_code: 204
      no_log: true
