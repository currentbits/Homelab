---
- name: Create secure deploy user
  hosts: all

  vars:
    deploy_user: "{{ lookup('env', 'DEPLOY_USER') | default('deploy', true) }}"
    deploy_user_pubkey: "{{ lookup('env', 'DEPLOY_USER_SSH_PUBKEY') }}"
    deploy_user_password: "{{ lookup('env', 'DEPLOY_USER_PASSWORD') }}"

  tasks:
    - name: Ensure deploy group exists
      group:
        name: "{{ deploy_user }}"
        state: present

    - name: Create deploy user with password
      user:
        name: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        shell: /bin/bash
        create_home: yes
        password: "{{ deploy_user_password }}"
        state: present

    - name: Add authorized key for deploy user
      authorized_key:
        user: "{{ deploy_user }}"
        key: "{{ deploy_user_pubkey }}"
        state: present

    - name: Add deploy user to sudo group
      user:
        name: "{{ deploy_user }}"
        groups: sudo
        append: true


    - name: Ensure home directory has correct permissions
      file:
        path: "/home/{{ deploy_user }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    - name: Notify Discord that the task is done
      uri:
        url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: |
          {
            "content": "âœ… Task '{{ ansible_play_name }}' completed successfully on host {{ inventory_hostname }}."
          }
        body_format: json
        status_code: 204
      no_log: true
