---
- name: Create secure deploy user
  hosts: all

  pre_tasks:
    - name: Ensure python3 and pip are installed
      package:
        name:
          - python3
          - python3-pip
        state: present

    - name: Ensure passlib is installed for password hashing
      pip:
        name: passlib
        state: present
      register: passlib_install
      ignore_errors: yes

    - name: Debug passlib installation result
      debug:
        msg: "passlib installation: {{ passlib_install }}"

  vars:
    deploy_user: "{{ lookup('env', 'DEPLOY_USER') | default('deploy', true) }}"
    deploy_user_pubkey: "{{ lookup('env', 'DEPLOY_USER_SSH_PUBKEY') }}"
    deploy_user_password: "{{ lookup('env', 'DEPLOY_USER_PASSWORD') }}"

  tasks:
    - name: Ensure deploy group exists
      group:
        name: "{{ deploy_user }}"
        state: present

    - name: Create deploy user with password
      user:
        name: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        shell: /bin/bash
        create_home: yes
        password: "{{ deploy_user_password }}"
        state: present

    - name: Add authorized key for deploy user
      authorized_key:
        user: "{{ deploy_user }}"
        key: "{{ deploy_user_pubkey }}"
        state: present

    - name: Add deploy user to sudoers (no password)
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "^{{ deploy_user }} "
        line: "{{ deploy_user }} ALL=(ALL) NOPASSWD:ALL"

    - name: Ensure home directory has correct permissions
      file:
        path: "/home/{{ deploy_user }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    - name: Notify Discord that the task is done
      uri:
        url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: |
          {
            "content": "âœ… Task '{{ ansible_play_name }}' completed successfully on host {{ inventory_hostname }}."
          }
        body_format: json
        status_code: 204
      no_log: true
